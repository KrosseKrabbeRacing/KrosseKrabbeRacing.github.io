<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>iRacing Results Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f8f8; color: #222; }
    h1 { color: #333; margin: 0 0 6px 0; }
    h2 { color: #333; margin: 6px 0 0 0; font-weight: 600; font-size: 1.05rem; }
    .controls { margin: 10px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .info { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 10px; }
    select { padding:6px; border-radius:5px; border:1px solid #aaa; font-size:14px; }
    button { padding:7px 10px; border-radius:6px; border:1px solid #999; background:#fff; cursor:pointer; }
    button:hover { filter:brightness(.98); }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; cursor: default; vertical-align: middle; }
    th { background-color: #eaeaea; user-select: none; }
    th.sortable { cursor:pointer; }
    tr.team-row:nth-child(even) { background: #f3f3f3; }
    .sortable:hover { background: #dcdcdc; }
    .asc::after { content: " ‚ñ≤"; }
    .desc::after { content: " ‚ñº"; }
    .error { color: darkred; background: #ffeeee; padding: 10px; border-radius: 5px; border: 1px solid #dd9999; }
    .highlight-team { background-color: #e4c1f9 !important; }
    .driver-row { background: #fcfcfc; }
    .driver-table { width: 96%; margin: 8px auto 12px auto; border-collapse:collapse; }
    .driver-table th, .driver-table td { border:1px solid #ddd; padding:6px; font-size:13px; text-align:left; }
    .toggle-button { cursor: pointer; }
    .flag { font-size: 1.05em; margin-left:3px; vertical-align:middle; }
    .fastest { color: #800080; font-weight: 600; }
    .dnf { color: #b00000; font-weight:700; margin-left:8px; font-size:0.9em; }
    @media (max-width:900px) {
      .driver-table td, .driver-table th { font-size:12px; padding:4px; }
    }
  </style>
</head>
<body>
  <h1 id="race-title">Loading Results...</h1>
  <div class="info" id="race-info"></div>

  <div class="controls">
    <label for="classFilter"><strong>Filter by class:</strong></label>
    <select id="classFilter"><option value="all">All Classes</option></select>
    <button id="resetBtn" title="Reset filters, sorting and folds">Reset</button>
  </div>

  <table id="results-table" aria-describedby="race-info">
    <thead>
      <tr>
        <th class="sortable" data-key="pos">Pos</th>
        <th class="sortable" data-key="team">Team</th>
        <th>Class</th>
        <th>Car</th>
        <th class="sortable" data-key="start">Start</th>
        <th class="sortable" data-key="interval">Interval</th>
        <th class="sortable" data-key="best">Best Lap</th>
        <th class="sortable" data-key="laps">Laps</th>
        <th class="sortable" data-key="inc">Incidents</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const teamName = "Krosse Krabbe Racing";
const usePartialTeamMatch = true;
let allResults = [], originalAllResults = [], selectedClass = "all", currentSort = { key:null, dir:null };
let jsonDataGlobal = null, classFastestMap = {};

// ISO mappings
const iso3To2 = { CHE:"CH", GBR:"GB", NLD:"NL", ESP:"ES", DEU:"DE", USA:"US", FRA:"FR", ITA:"IT" };
function countryToFlag(code){
  if(code==="EN") return "üè¥";
  if(!code||code.length!==2)return "";
  const A=0x1F1E6;return String.fromCodePoint(...[...code.toUpperCase()].map(c=>A+c.charCodeAt(0)-65));
}
function safeGet(o,...k){for(const x of k)if(o&&x in o&&o[x]!=null)return o[x];return null;}
function msValueToSeconds(v){return v>0?v/10000:null;}
function formatTimeFromValue(v){const s=msValueToSeconds(v);if(!s)return"-";const m=Math.floor(s/60),sec=Math.floor(s%60),ms=Math.round((s%1)*1000);return`${m}:${String(sec).padStart(2,"0")}.${String(ms).padStart(3,"0")}`;}
function getQueryParam(p){return new URLSearchParams(window.location.search).get(p);}
function getTwoLetterCodeForDriver(d){const cc=safeGet(d,"country_code");if(cc&&cc.length===2)return cc.toUpperCase();const fl=safeGet(d,"flair_shortname");if(fl&&fl.length===3){const map=iso3To2[fl.toUpperCase()];return map||fl.substring(0,2).toUpperCase();}return fl&&fl.length===2?fl.toUpperCase():"";}
function formatDateTime(start,end){
  const s=new Date(start), e=new Date(end);
  const pad=n=>String(n).padStart(2,"0");
  return `Date: ${pad(s.getDate())}/${pad(s.getMonth()+1)}/${s.getFullYear()}, Start: ${pad(s.getHours())}:${pad(s.getMinutes())}, Finish: ${pad(e.getHours())}:${pad(e.getMinutes())}`;
}
async function loadResults(){
  const file=getQueryParam("file");
  if(!file){document.body.innerHTML="<div class='error'>‚ö†Ô∏è No JSON file specified.<br>Usage: ?file=eventresult.json</div>";return;}
  try{
    const r=await fetch(file);if(!r.ok)throw new Error("File not found");const j=await r.json();const d=j.data;jsonDataGlobal=d;
    const trackName=safeGet(d,"track","track_name","track_display_name","track_name_full")||"-";
    const trackLayout=safeGet(d,"track_layout","track_config_name","track_layout_name")||"";
    const sof=safeGet(d,"event_strength_of_field")??"‚Äî", lead=safeGet(d,"num_lead_changes")??"‚Äî";
    const totalDrivers=d.num_drivers??"‚Äî";const sessions=d.session_results||[];
    let session=sessions.find(s=>s.simsession_type_name?.toLowerCase().includes("race"))||sessions[0];
    const subs=d.associated_subsession_ids||[], cur=d.subsession_id;
    let splitHtml="";if(Array.isArray(subs)&&subs.length>0){const total=subs.length,idx=subs.indexOf(cur);splitHtml=`<br><strong>Split:</strong> ${idx>=0?idx+1:1}/${total}`;}
    const timeInfo=formatDateTime(d.start_time||d.start||d.session_start_time||d.start_time_utc||d.start_time_string,d.end_time||d.finish_time||d.session_end_time||d.finish_time_utc||d.end_time_string);
    document.getElementById("race-title").innerText=d.season_name||d.series_name||"iRacing Results";
    document.getElementById("race-info").innerHTML=
      `<strong>Series:</strong> ${d.series_name||"‚Äî"}<br>
       <strong>Track:</strong> ${trackName}${trackLayout?" ‚Äî "+trackLayout:""}<br>
       <strong>${timeInfo}</strong><br>
       <strong>Car Classes:</strong> ${(d.car_classes||[]).map(c=>c.name).join(", ")||"‚Äî"}<br>
       <strong>Total Drivers:</strong> ${totalDrivers}<br>
       <strong>Total Teams:</strong> ${(session.results||[]).length}<br>
       <strong>Strength of Field:</strong> ${sof}<br>
       <strong>Lead Changes:</strong> ${lead}${splitHtml}`;
    allResults=(session.results||[]).map(t=>({ ...t,__numeric:{pos_overall:t.finish_position??t.position??null,pos_class:t.finish_position_in_class??null,best:t.best_lap_time>0?t.best_lap_time:null,laps:t.laps_complete??0,inc:t.incidents??0}}));
    classFastestMap={};allResults.forEach(t=>{const c=t.car_class_name||"unknown";const b=t.__numeric.best;if(b&&( !(c in classFastestMap)||b<classFastestMap[c]))classFastestMap[c]=b;(t.driver_results||[]).forEach(d=>{const db=safeGet(d,"best_lap_time");if(db&&( !(c in classFastestMap)||db<classFastestMap[c]))classFastestMap[c]=db;});});
    originalAllResults=JSON.parse(JSON.stringify(allResults));
    populateClassFilter();renderTable();enableTableSorting();setupResetButton();
  }catch(e){document.body.innerHTML=`<div class='error'>‚ö†Ô∏è ${e.message}</div>`;}
}
function populateClassFilter(){
  const s=document.getElementById("classFilter");
  s.querySelectorAll("option:not([value='all'])").forEach(o=>o.remove());
  [...new Set(allResults.map(r=>r.car_class_name).filter(Boolean))].sort().forEach(c=>{
    const o=document.createElement("option");o.value=c;o.textContent=c;s.appendChild(o);
  });s.value="all";s.onchange=e=>{selectedClass=e.target.value;currentSort={};clearSortIndicators();renderTable();};
}
function renderTable(){
  const tb=document.querySelector("#results-table tbody");tb.innerHTML="";
  let v=selectedClass==="all"?allResults.slice():allResults.filter(t=>t.car_class_name===selectedClass);
  const leader=v.length?v[0]:null;const leaderLaps=leader?.laps_complete??0;
  const classOrder={};if(selectedClass!=="all"){v.slice().sort((a,b)=>(a.__numeric.pos_overall??1e9)-(b.__numeric.pos_overall??1e9)).forEach((t,i)=>classOrder[t.team_id]=i+1);}
  if(currentSort.key)v.sort((a,b)=>compareForSort(a,b,currentSort.key,currentSort.dir));
  v.forEach(t=>{
    const tr=document.createElement("tr");tr.classList.add("team-row");
    const name=(t.display_name||"-");const dLow=name.toLowerCase(),target=teamName.toLowerCase();
    if(usePartialTeamMatch?dLow.includes(target):dLow===target)tr.classList.add("highlight-team");
    let pos=(selectedClass!=="all"?classOrder[t.team_id]:t.__numeric.pos_overall)+1||"-";
    let posHtml=pos;if(selectedClass!=="all"&&typeof pos==="number"){if(pos===1)posHtml=`1 ü•á`;else if(pos===2)posHtml=`2 ü•à`;else if(pos===3)posHtml=`3 ü•â`;}
    const drivers=t.driver_results||[];const codes=[...new Set(drivers.map(getTwoLetterCodeForDriver).filter(Boolean))];
    const flags=codes.map(c=>countryToFlag(c)).join("");const driverCount=drivers.length;
    const driverIcon=driverCount>1?"üë•":"üë§";
    const reason=safeGet(t,"reason_out")||"",rid=safeGet(t,"reason_out_id");const dnf=(reason&&reason.toLowerCase()!=="running")||(rid&&rid!==0);
    const bestRaw=t.__numeric.best,best=formatTimeFromValue(bestRaw),clsBest=classFastestMap[t.car_class_name];
    const bestClass=(clsBest&&bestRaw&&clsBest===bestRaw)?"fastest":"";
    const start=(safeGet(t,"starting_position")??-1)+1;const intervalLaps=leaderLaps-t.laps_complete;
    const interval=intervalLaps===0?"On Lead Lap":`‚Äì${intervalLaps} Lap${intervalLaps>1?"s":""}`;
    tr.innerHTML=`
      <td>${posHtml}</td>
      <td>${name} ${driverIcon}${driverCount}${flags?" "+flags:""}${dnf?'<span class="dnf">DNF</span>':""}</td>
      <td>${t.car_class_name||"-"}</td>
      <td>${t.car_name||"-"}</td>
      <td>${start>0?start:"-"}</td>
      <td>${interval}</td>
      <td class="${bestClass}">${best}</td>
      <td>${t.laps_complete??0}</td>
      <td>${t.incidents??0}</td>`;
    tr.onclick=()=>{const n=tr.nextElementSibling;if(n&&n.classList.contains("driver-row"))n.remove();else{const dr=document.createElement("tr");dr.classList.add("driver-row");const td=document.createElement("td");td.colSpan=9;td.style.padding="10px";td.innerHTML=buildDriverTable(t);dr.appendChild(td);tr.after(dr);}};
    tb.appendChild(tr);
  });
  applySortIndicatorToHeader();
}
function buildDriverTable(team){
  const d=team.driver_results||[],cb=classFastestMap[team.car_class_name];
  let h=`<table class="driver-table"><thead><tr><th>Name</th><th>Country</th><th>License</th><th>Rating</th><th>Laps</th><th>Laps Led</th><th>Avg Lap</th><th>Fastest Lap</th><th>Fast Lap Nr</th><th>Inc</th><th>Champ Pts</th><th>Div</th></tr></thead><tbody>`;
  d.forEach(x=>{
    const code=getTwoLetterCodeForDriver(x);const flag=countryToFlag(code);const country=flag||"";
    const L=getLicenseLetterForDriver(x);const os=safeGet(x,"old_sub_level"),ns=safeGet(x,"new_sub_level");
    let saf="-";if(os!=null){const prior=os/100,delta=(ns!=null?(ns-os)/100:0);const sign=delta>0?`+${delta.toFixed(1)}`:delta<0?`${delta.toFixed(1)}`:"+0.0";saf=`${L} ${prior.toFixed(1)} ${sign}`;}
    const oi=safeGet(x,"oldi_rating"),ni=safeGet(x,"newi_rating");let ir="-";if(oi!=null){const delta=(ni!=null?ni-oi:0);const sign=delta>0?`+${delta}`:delta<0?`${delta}`:"+0";ir=`${oi} ${sign}`;}
    const laps=x.laps_complete??0,ll=x.laps_lead??0,avg=x.average_lap?formatTimeFromValue(x.average_lap):"-",f=x.best_lap_time?formatTimeFromValue(x.best_lap_time):"-",fn=x.best_lap_num??"-",inc=x.incidents??0,ch=x.champ_points??x.aggregate_champ_points??0,div=x.division_name||x.division||"-";
    const fast=(cb&&x.best_lap_time&&cb===x.best_lap_time)?"fastest":"";
    h+=`<tr><td>${x.display_name||"-"}</td><td>${country}</td><td>${saf}</td><td>${ir}</td><td>${laps}</td><td>${ll}</td><td>${avg}</td><td class="${fast}">${f}</td><td>${fn}</td><td>${inc}</td><td>${ch}</td><td>${div}</td></tr>`;
  });
  return h+"</tbody></table>";
}
function getLicenseLetterForDriver(d){
  const lvl=safeGet(d,"old_license_level","new_license_level");if(lvl==null)return"-";
  const a=jsonDataGlobal?.allowed_licenses;if(a)for(const x of a){if(lvl>=x.min_license_level&&lvl<=x.max_license_level){const m=x.group_name?.match(/Class\s+([A-Z])/i);return m?m[1].toUpperCase():x.group_name;}}
  if(lvl<=8)return"D";if(lvl<=12)return"C";if(lvl<=16)return"B";if(lvl<=20)return"A";if(lvl<=24)return"Pro";return"Pro/WC";
}
function enableTableSorting(){document.querySelectorAll("th.sortable").forEach(h=>h.onclick=()=>{const k=h.dataset.key,a=h.classList.contains("asc"),d=a?"desc":"asc";clearSortIndicators();h.classList.add(d);currentSort={key:k,dir:d};renderTable();});}
function clearSortIndicators(){document.querySelectorAll("th.sortable").forEach(h=>h.classList.remove("asc","desc"));}
function applySortIndicatorToHeader(){if(!currentSort.key)return;const th=document.querySelector(`th.sortable[data-key='${currentSort.key}']`);if(th){th.classList.add(currentSort.dir);}}
function compareForSort(a,b,k,d){const s=d==="asc"?1:-1;if(k==="pos"){return((a.__numeric.pos_overall??1e9)-(b.__numeric.pos_overall??1e9))*s;}
if(k==="team")return(a.display_name||"").localeCompare(b.display_name||"")*s;if(k==="start")return(((a.starting_position??0)-(b.starting_position??0))*s);
if(k==="interval")return((a.laps_complete??0)-(b.laps_complete??0))*s*-1;if(k==="best")return(((a.__numeric.best??1e12)-(b.__numeric.best??1e12))*s);
if(k==="laps")return((a.laps_complete??0)-(b.laps_complete??0))*s*-1;if(k==="inc")return((a.incidents??0)-(b.incidents??0))*s;return 0;}
function setupResetButton(){document.getElementById("resetBtn").onclick=()=>{selectedClass="all";currentSort={};clearSortIndicators();document.getElementById("classFilter").value="all";document.querySelectorAll(".driver-row").forEach(r=>r.remove());allResults=JSON.parse(JSON.stringify(originalAllResults));renderTable();};}
loadResults();
</script>
</body>
</html>
