<!-- =====================================================
  iRacing Results Viewer v1.7
  Author: KrosseKrabbeRacing & ChatGPT
  Description:
    - Adds DSQ indicator for disqualified teams
    - Fixes starting position display (pole = 1)
    - Adds Car Brand sorting
    - Retains all prior features: class filters, foldable teams,
      purple per-class fastest laps, reset, DNF, etc.
  ===================================================== -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>iRacing Results Viewer v1.7</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f8f8f8;
      color: #222;
    }

    h1 {
      color: #333;
      margin-bottom: 6px;
    }

    .info {
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .controls {
      margin: 10px 0;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select,
    button {
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid #aaa;
      font-size: 14px;
    }

    button:hover {
      filter: brightness(0.98);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      background: white;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background-color: #eaeaea;
      user-select: none;
    }

    th.sortable {
      cursor: pointer;
    }

    tr.team-row:nth-child(even) {
      background: #f3f3f3;
    }

    tr.team-row:hover {
      background: #efefef;
    }

    .asc::after {
      content: " ▲";
    }

    .desc::after {
      content: " ▼";
    }

    .highlight-team {
      background-color: #e4c1f9 !important;
    }

    .driver-row {
      background: #fcfcfc;
    }

    .driver-table {
      width: 96%;
      margin: 8px auto 12px auto;
      border-collapse: collapse;
    }

    .driver-table th, .driver-table td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 13px;
      text-align: left;
    }

    .fastest {
      color: #800080;
      font-weight: 600;
    }

    .dnf, .dsq {
      color: #b00000;
      font-weight: 700;
      margin-left: 8px;
      font-size: 0.9em;
    }
  </style>
</head>

<body>
  <h1 id="race-title">Loading Results...</h1>
  <div class="info" id="race-info"></div>

  <div class="controls">
    <label for="classFilter"><strong>Filter by class:</strong></label>
    <select id="classFilter">
      <option value="all">All Classes</option>
    </select>
    <button id="resetBtn">Reset</button>
  </div>

  <table id="results-table">
    <thead>
      <tr>
        <th class="sortable" data-key="pos">Pos</th>
        <th class="sortable" data-key="team">Team</th>
        <th class="sortable" data-key="class">Class</th>
        <th class="sortable" data-key="car">Car</th>
        <th class="sortable" data-key="start">Start</th>
        <th class="sortable" data-key="interval">Interval</th>
        <th class="sortable" data-key="best">Best Lap</th>
        <th class="sortable" data-key="laps">Laps</th>
        <th class="sortable" data-key="inc">Incidents</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    /* =====================================================
       iRacing Results Viewer v1.7
       ===================================================== */

    const teamName = "Krosse Krabbe Racing";
    const usePartialTeamMatch = true;
    let allResults = [];
    let originalAllResults = [];
    let selectedClass = "all";
    let currentSort = { key: null, dir: null };
    let jsonDataGlobal = null;
    let classFastestMap = {};

    /* ---------- Utility functions ---------- */
    function safeGet(obj, ...keys) {
      for (const key of keys) {
        if (obj && key in obj && obj[key] != null) return obj[key];
      }
      return null;
    }

    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    function msToTime(msVal) {
      if (!msVal || msVal <= 0) return "-";
      const sec = msVal / 10000;
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      const ms = Math.round((sec % 1) * 1000);
      return `${m}:${pad2(s)}.${String(ms).padStart(3, "0")}`;
    }

    /* ---------- Load JSON ---------- */
    async function loadResults() {
      const file = new URLSearchParams(window.location.search).get("file");
      if (!file) {
        document.body.innerHTML = "<div>⚠️ No JSON file specified.</div>";
        return;
      }

      const res = await fetch(file);
      if (!res.ok) {
        document.body.innerHTML = "<div>⚠️ File not found.</div>";
        return;
      }

      const json = await res.json();
      const data = json.data;
      jsonDataGlobal = data;

      const track = safeGet(data, "track") || {};
      const trackName = safeGet(track, "track_name", "name") || "-";
      const layout = safeGet(track, "config_name", "layout_name") || "";
      const sof = safeGet(data, "event_strength_of_field") ?? "—";
      const leadChanges = safeGet(data, "num_lead_changes") ?? "—";

      const sessions = data.session_results || [];
      const session =
        sessions.find((s) =>
          s.simsession_type_name?.toLowerCase().includes("race")
        ) || sessions[0] || { results: [] };

      const subs = data.associated_subsession_ids || [];
      const cur = data.subsession_id;
      let splitHtml = "";
      if (Array.isArray(subs) && subs.length > 0) {
        const total = subs.length;
        const idx = subs.indexOf(cur);
        splitHtml = `<br><strong>Split:</strong> ${
          idx >= 0 ? idx + 1 : 1
        }/${total}`;
      }

      const startTime =
        safeGet(data, "start_time", "session_start_time", "start_time_utc") ||
        new Date();
      const endTime =
        safeGet(data, "end_time", "session_end_time", "finish_time_utc") ||
        new Date();

      const start = new Date(startTime);
      const end = new Date(endTime);
      const dateLine = `<strong>Date:</strong> ${pad2(
        start.getDate()
      )}/${pad2(start.getMonth() + 1)}/${start.getFullYear()}, Start: ${pad2(
        start.getHours()
      )}:${pad2(start.getMinutes())}, Finish: ${pad2(
        end.getHours()
      )}:${pad2(end.getMinutes())}`;

      document.getElementById("race-title").innerText =
        safeGet(data, "season_name") ||
        safeGet(data, "series_name") ||
        "iRacing Results";

      document.getElementById("race-info").innerHTML = `
        <strong>Series:</strong> ${safeGet(data, "series_name") || "—"}<br>
        <strong>Track:</strong> ${trackName}${
        layout ? " — " + layout : ""
      }<br>
        ${dateLine}<br>
        <strong>Car Classes:</strong> ${(data.car_classes || [])
          .map((c) => c.name)
          .join(", ") || "—"}<br>
        <strong>Total Drivers:</strong> ${data.num_drivers ?? "—"}<br>
        <strong>Total Teams:</strong> ${(session.results || []).length}<br>
        <strong>Strength of Field:</strong> ${sof}<br>
        <strong>Lead Changes:</strong> ${leadChanges}${splitHtml}
      `;

      allResults = (session.results || []).map((team) => ({
        ...team,
        __numeric: {
          pos_overall: team.finish_position ?? team.position ?? null,
          pos_class: team.finish_position_in_class ?? null,
          best: team.best_lap_time > 0 ? team.best_lap_time : null,
          laps: team.laps_complete ?? 0,
          inc: team.incidents ?? 0,
        },
      }));

      computeFastestLaps();
      originalAllResults = JSON.parse(JSON.stringify(allResults));
      populateClassFilter();
      renderTable();
      enableSorting();
      setupReset();
    }

    /* ---------- Compute per-class fastest laps ---------- */
    function computeFastestLaps() {
      classFastestMap = {};
      allResults.forEach((t) => {
        const c = t.car_class_name || "unknown";
        const best = t.best_lap_time;
        if (best > 0)
          classFastestMap[c] = classFastestMap[c]
            ? Math.min(classFastestMap[c], best)
            : best;
      });
    }

    /* ---------- Filters ---------- */
    function populateClassFilter() {
      const sel = document.getElementById("classFilter");
      sel.querySelectorAll("option:not([value='all'])").forEach((o) => o.remove());
      const classes = [...new Set(allResults.map((r) => r.car_class_name))].filter(Boolean).sort();
      classes.forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
      sel.onchange = (e) => {
        selectedClass = e.target.value;
        renderTable();
      };
    }

    /* ---------- Table rendering ---------- */
    function renderTable() {
      const tbody = document.querySelector("#results-table tbody");
      tbody.innerHTML = "";
      let view = selectedClass === "all"
        ? allResults.slice()
        : allResults.filter((t) => t.car_class_name === selectedClass);

      const overallLeaderLaps = Math.max(...allResults.map(t => t.laps_complete ?? 0), 0);
      const classLeaderLaps = Math.max(...view.map(t => t.laps_complete ?? 0), 0);

      if (currentSort.key) view.sort((a, b) => compareForSort(a, b, currentSort.key, currentSort.dir));

      view.forEach((team) => {
        const tr = document.createElement("tr");
        tr.classList.add("team-row");

        // Highlight own team
        const teamLower = (team.display_name || "").toLowerCase();
        const targetLower = teamName.toLowerCase();
        if (usePartialTeamMatch ? teamLower.includes(targetLower) : teamLower === targetLower)
          tr.classList.add("highlight-team");

        // Determine DSQ / DNF
        const reason = (team.reason_out || "").toLowerCase();
        const reasonId = team.reason_out_id;
        const isDNF = reason && reason !== "running" && !reason.includes("disqual");
        const isDSQ = reason.includes("disqual") || reasonId === 5;

        // Starting position (fixed +1)
        const startVal = team.starting_position;
        const startDisplay = startVal != null ? startVal + 1 : "-";

        // Interval
        const laps = team.laps_complete ?? 0;
        const leaderLaps = selectedClass === "all" ? overallLeaderLaps : classLeaderLaps;
        const delta = leaderLaps - laps;
        const interval = delta === 0 ? "-" : `–${delta} Lap${delta > 1 ? "s" : ""}`;

        // Best lap
        const best = team.best_lap_time;
        const bestStr = best > 0 ? msToTime(best) : "-";
        const isFastest = classFastestMap[team.car_class_name] === best;

        // Position (overall or per class)
        let pos = team.finish_position_in_class ?? team.finish_position;
        if (pos != null) pos += 1;

        tr.innerHTML = `
          <td>${pos ?? "-"}</td>
          <td>${escapeHtml(team.display_name || "-")} ${isDNF ? "<span class='dnf'>DNF</span>" : ""}${isDSQ ? "<span class='dsq'>DSQ</span>" : ""}</td>
          <td>${escapeHtml(team.car_class_name || "-")}</td>
          <td>${escapeHtml(team.car_name || "-")}</td>
          <td>${startDisplay}</td>
          <td>${interval}</td>
          <td class="${isFastest ? "fastest" : ""}">${bestStr}</td>
          <td>${team.laps_complete ?? 0}</td>
          <td>${team.incidents ?? 0}</td>
        `;

        tr.addEventListener("click", () => toggleDrivers(tr, team));
        tbody.appendChild(tr);
      });
    }

    /* ---------- Driver expansion ---------- */
    function toggleDrivers(tr, team) {
      const next = tr.nextElementSibling;
      if (next && next.classList.contains("driver-row")) {
        next.remove();
        return;
      }
      const dr = document.createElement("tr");
      dr.classList.add("driver-row");
      const td = document.createElement("td");
      td.colSpan = 9;
      td.innerHTML = buildDriverTable(team);
      dr.appendChild(td);
      tr.parentNode.insertBefore(dr, tr.nextSibling);
    }

    function buildDriverTable(team) {
      const drivers = team.driver_results || [];
      const classBest = classFastestMap[team.car_class_name];
      let html = `<table class="driver-table"><thead>
        <tr><th>Name</th><th>Country</th><th>License</th><th>Rating</th>
        <th>Laps</th><th>Laps Led</th><th>Avg Lap</th><th>Best Lap</th>
        <th>Best Lap Nr</th><th>Inc</th><th>Champ Pts</th><th>Div</th></tr>
      </thead><tbody>`;

      drivers.forEach((d) => {
        const fastest = d.best_lap_time > 0 ? msToTime(d.best_lap_time) : "-";
        const isFastest = classBest === d.best_lap_time;
        html += `<tr>
          <td>${escapeHtml(d.display_name)}</td>
          <td>${escapeHtml(d.flair_shortname || "-")}</td>
          <td>${escapeHtml(d.new_license_level ?? "-")}</td>
          <td>${escapeHtml(d.newi_rating ?? "-")}</td>
          <td>${escapeHtml(d.laps_complete ?? "-")}</td>
          <td>${escapeHtml(d.laps_lead ?? "-")}</td>
          <td>${msToTime(d.average_lap)}</td>
          <td class="${isFastest ? "fastest" : ""}">${fastest}</td>
          <td>${escapeHtml(d.best_lap_num ?? "-")}</td>
          <td>${escapeHtml(d.incidents ?? "-")}</td>
          <td>${escapeHtml(d.champ_points ?? "-")}</td>
          <td>${escapeHtml(d.division_name ?? "-")}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      return html;
    }

    /* ---------- Sorting ---------- */
    function enableSorting() {
      document.querySelectorAll("th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.key;
          const dir = th.classList.contains("asc") ? "desc" : "asc";
          clearSortIndicators();
          th.classList.add(dir);
          currentSort = { key, dir };
          renderTable();
        });
      });
    }

    function clearSortIndicators() {
      document.querySelectorAll("th.sortable").forEach((th) =>
        th.classList.remove("asc", "desc")
      );
    }

    function compareForSort(a, b, key, dir) {
      const s = dir === "asc" ? 1 : -1;
      switch (key) {
        case "pos":
          return ((a.finish_position ?? 0) - (b.finish_position ?? 0)) * s;
        case "team":
          return (a.display_name || "").localeCompare(b.display_name || "") * s;
        case "class":
          return (a.car_class_name || "").localeCompare(b.car_class_name || "") * s;
        case "car":
          return (a.car_name || "").localeCompare(b.car_name || "") * s;
        case "start":
          return ((a.starting_position ?? 0) - (b.starting_position ?? 0)) * s;
        case "interval":
          return ((a.laps_complete ?? 0) - (b.laps_complete ?? 0)) * s * -1;
        case "best":
          return ((a.best_lap_time ?? 1e12) - (b.best_lap_time ?? 1e12)) * s;
        case "laps":
          return ((a.laps_complete ?? 0) - (b.laps_complete ?? 0)) * s * -1;
        case "inc":
          return ((a.incidents ?? 0) - (b.incidents ?? 0)) * s;
        default:
          return 0;
      }
    }

    /* ---------- Reset ---------- */
    function setupReset() {
      document.getElementById("resetBtn").addEventListener("click", () => {
        selectedClass = "all";
        document.getElementById("classFilter").value = "all";
        currentSort = { key: null, dir: null };
        clearSortIndicators();
        document.querySelectorAll(".driver-row").forEach((r) => r.remove());
        allResults = JSON.parse(JSON.stringify(originalAllResults));
        renderTable();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }

    /* ---------- Init ---------- */
    loadResults();
  </script>
</body>
</html>
