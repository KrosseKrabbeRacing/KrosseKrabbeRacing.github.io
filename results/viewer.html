<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>iRacing Results Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f8f8; color: #222; }
    h1 { color: #333; margin: 0 0 6px 0; }
    .controls { margin: 10px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .info { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 10px; line-height:1.4; }
    select,button { padding:6px 10px; border-radius:5px; border:1px solid #aaa; font-size:14px; }
    button:hover { filter:brightness(.98); }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: middle; }
    th { background-color: #eaeaea; user-select: none; }
    th.sortable { cursor:pointer; }
    tr.team-row:nth-child(even) { background: #f3f3f3; }
    .sortable:hover { background: #dcdcdc; }
    .asc::after { content: " ‚ñ≤"; }
    .desc::after { content: " ‚ñº"; }
    .highlight-team { background-color: #e4c1f9 !important; }
    .driver-row { background: #fcfcfc; }
    .driver-table { width: 96%; margin: 8px auto 12px auto; border-collapse:collapse; }
    .driver-table th, .driver-table td { border:1px solid #ddd; padding:6px; font-size:13px; text-align:left; }
    .fastest { color: #800080; font-weight: 600; }
    .dnf { color: #b00000; font-weight:700; margin-left:8px; font-size:0.9em; }
  </style>
</head>
<body>
  <h1 id="race-title">Loading Results...</h1>
  <div class="info" id="race-info"></div>

  <div class="controls">
    <label for="classFilter"><strong>Filter by class:</strong></label>
    <select id="classFilter"><option value="all">All Classes</option></select>
    <button id="resetBtn">Reset</button>
  </div>

  <table id="results-table">
    <thead>
      <tr>
        <th class="sortable" data-key="pos">Pos</th>
        <th class="sortable" data-key="team">Team</th>
        <th>Class</th>
        <th>Car</th>
        <th class="sortable" data-key="start">Start</th>
        <th class="sortable" data-key="interval">Interval</th>
        <th class="sortable" data-key="best">Best Lap</th>
        <th class="sortable" data-key="laps">Laps</th>
        <th class="sortable" data-key="inc">Incidents</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const teamName="Krosse Krabbe Racing";
const usePartialTeamMatch=true;
let allResults=[],originalAllResults=[],selectedClass="all",currentSort={key:null,dir:null},jsonDataGlobal=null,classFastestMap={};

function safeGet(o,...k){for(const x of k)if(o&&x in o&&o[x]!=null)return o[x];return null;}
function msValueToSeconds(v){return v>0?v/10000:null;}
function formatTime(v){const s=msValueToSeconds(v);if(!s)return"-";const m=Math.floor(s/60),sec=Math.floor(s%60),ms=Math.round((s%1)*1000);return`${m}:${String(sec).padStart(2,"0")}.${String(ms).padStart(3,"0")}`;}
function pad2(n){return String(n).padStart(2,"0");}
function formatDate(start,end){const s=new Date(start),e=new Date(end);return`<strong>Date:</strong> ${pad2(s.getDate())}/${pad2(s.getMonth()+1)}/${s.getFullYear()}, Start: ${pad2(s.getHours())}:${pad2(s.getMinutes())}, Finish: ${pad2(e.getHours())}:${pad2(e.getMinutes())}`;}

async function loadResults(){
  const file=new URLSearchParams(window.location.search).get("file");
  if(!file){document.body.innerHTML="<div class='error'>‚ö†Ô∏è No JSON file specified.</div>";return;}
  const r=await fetch(file);if(!r.ok)throw new Error("File not found");const j=await r.json();const d=j.data;jsonDataGlobal=d;
  const trackObj=safeGet(d,"track")||{},trackName=trackObj.track_name||trackObj.name||"-",layout=trackObj.config_name||trackObj.layout_name||"";
  const sof=safeGet(d,"event_strength_of_field")??"‚Äî",lead=safeGet(d,"num_lead_changes")??"‚Äî";
  const sessions=d.session_results||[];let s=sessions.find(x=>x.simsession_type_name?.toLowerCase().includes("race"))||sessions[0];
  const subs=d.associated_subsession_ids||[],cur=d.subsession_id;let splitHtml="";if(subs.length){const t=subs.length,i=subs.indexOf(cur);splitHtml=`<br><strong>Split:</strong> ${i>=0?i+1:1}/${t}`;}
  const start=safeGet(d,"start_time","session_start_time"),end=safeGet(d,"end_time","session_end_time");
  document.getElementById("race-title").innerText=d.season_name||d.series_name||"iRacing Results";
  document.getElementById("race-info").innerHTML=
  `<strong>Series:</strong> ${d.series_name||"‚Äî"}<br>
   <strong>Track:</strong> ${trackName}${layout?" ‚Äî "+layout:""}<br>
   ${formatDate(start,end)}<br>
   <strong>Car Classes:</strong> ${(d.car_classes||[]).map(c=>c.name).join(", ")||"‚Äî"}<br>
   <strong>Total Teams:</strong> ${(s.results||[]).length}<br>
   <strong>Total Drivers:</strong> ${d.num_drivers??"‚Äî"}<br>
   <strong>Strength of Field:</strong> ${sof}<br>
   <strong>Lead Changes:</strong> ${lead}${splitHtml}`;
  allResults=s.results.map(t=>({...t,__n:{pos:t.finish_position??t.position??null,posc:t.finish_position_in_class??null,best:t.best_lap_time>0?t.best_lap_time:null,laps:t.laps_complete??0,inc:t.incidents??0}}));
  classFastestMap={};allResults.forEach(t=>{const c=t.car_class_name||"unknown";const b=t.__n.best;if(b&&(!(c in classFastestMap)||b<classFastestMap[c]))classFastestMap[c]=b;(t.driver_results||[]).forEach(dr=>{const db=dr.best_lap_time;if(db&&(!(c in classFastestMap)||db<classFastestMap[c]))classFastestMap[c]=db;});});
  originalAllResults=JSON.parse(JSON.stringify(allResults));populateClassFilter();renderTable();enableSort();setupReset();
}

function populateClassFilter(){
  const sel=document.getElementById("classFilter");sel.querySelectorAll("option:not([value='all'])").forEach(o=>o.remove());
  [...new Set(allResults.map(r=>r.car_class_name))].sort().forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;sel.appendChild(o);});
  sel.onchange=e=>{selectedClass=e.target.value;currentSort={};renderTable();};
}

function renderTable(){
  const tb=document.querySelector("#results-table tbody");tb.innerHTML="";
  const leaderLaps=Math.max(...allResults.map(x=>x.laps_complete??0),0);
  let view=selectedClass==="all"?allResults.slice():allResults.filter(x=>x.car_class_name===selectedClass);
  const classOrder={};if(selectedClass!=="all"){view.slice().sort((a,b)=>(a.__n.posc??1e9)-(b.__n.posc??1e9)).forEach((t,i)=>classOrder[t.team_id]=i+1);}
  if(currentSort.key)view.sort((a,b)=>compareSort(a,b,currentSort.key,currentSort.dir));
  view.forEach(t=>{
    const tr=document.createElement("tr");tr.classList.add("team-row");
    const name=t.display_name||"-";const low=name.toLowerCase(),target=teamName.toLowerCase();
    if(usePartialTeamMatch?low.includes(target):low===target)tr.classList.add("highlight-team");
    let pos=selectedClass!=="all"?(classOrder[t.team_id]||t.__n.posc+1):(t.__n.pos??0)+1;
    let posTxt=pos;if(pos===1)posTxt=`1 ü•á`;else if(pos===2)posTxt=`2 ü•à`;else if(pos===3)posTxt=`3 ü•â`;
    const best=formatTime(t.__n.best),cb=classFastestMap[t.car_class_name];const bestC=cb&&t.__n.best&&cb===t.__n.best?"fastest":"";
    const start=t.starting_position??"-";
    const lapsBehind=leaderLaps-(t.laps_complete??0);const interval=lapsBehind===0?"On Lead Lap":`‚Äì${lapsBehind} Lap${lapsBehind>1?"s":""}`;
    const dnf=(t.reason_out&&t.reason_out.toLowerCase()!=="running")||(t.reason_out_id&&t.reason_out_id!==0);
    tr.innerHTML=`<td>${posTxt}</td><td>${name}${dnf?'<span class="dnf">DNF</span>':""}</td><td>${t.car_class_name||"-"}</td><td>${t.car_name||"-"}</td><td>${start}</td><td>${interval}</td><td class="${bestC}">${best}</td><td>${t.laps_complete??0}</td><td>${t.incidents??0}</td>`;
    tr.onclick=()=>{const n=tr.nextElementSibling;if(n&&n.classList.contains("driver-row"))n.remove();else{const dr=document.createElement("tr");dr.classList.add("driver-row");const td=document.createElement("td");td.colSpan=9;td.innerHTML=buildDrivers(t);dr.appendChild(td);tr.after(dr);}};
    tb.appendChild(tr);
  });
}

function buildDrivers(t){
  const d=t.driver_results||[],cb=classFastestMap[t.car_class_name];
  let h=`<table class="driver-table"><thead><tr><th>Name</th><th>License</th><th>Rating</th><th>Laps</th><th>Laps Led</th><th>Avg Lap</th><th>Fastest Lap</th><th>Fast Lap Nr</th><th>Inc</th><th>Champ Pts</th><th>Div</th></tr></thead><tbody>`;
  d.forEach(x=>{
    const L=getLicenseLetter(x),os=x.old_sub_level,ns=x.new_sub_level;let lic="-";if(os!=null){const p=os/100,Œî=(ns!=null?(ns-os)/100:0);const s=Œî>0?`+${Œî.toFixed(1)}`:Œî.toFixed(1);lic=`${L} ${p.toFixed(1)} ${s}`;}
    const oi=x.oldi_rating,ni=x.newi_rating;let ir="-";if(oi!=null){const Œî=(ni!=null?ni-oi:0);const s=Œî>0?`+${Œî}`:Œî.toString();ir=`${oi} ${s}`;}
    const avg=x.average_lap?formatTime(x.average_lap):"-",f=x.best_lap_time?formatTime(x.best_lap_time):"-",fn=x.best_lap_num??"-";
    const fast=(cb&&x.best_lap_time&&cb===x.best_lap_time)?"fastest":"";h+=`<tr><td>${x.display_name||"-"}</td><td>${lic}</td><td>${ir}</td><td>${x.laps_complete??0}</td><td>${x.laps_lead??0}</td><td>${avg}</td><td class="${fast}">${f}</td><td>${fn}</td><td>${x.incidents??0}</td><td>${x.champ_points??0}</td><td>${x.division_name||x.division||"-"}</td></tr>`;
  });return h+"</tbody></table>";
}

function getLicenseLetter(d){const l=d.old_license_level??d.new_license_level;if(l==null)return"-";if(l<=8)return"D";if(l<=12)return"C";if(l<=16)return"B";if(l<=20)return"A";if(l<=24)return"Pro";return"Pro/WC";}
function enableSort(){document.querySelectorAll("th.sortable").forEach(h=>h.onclick=()=>{const k=h.dataset.key,d=h.classList.contains("asc")?"desc":"asc";document.querySelectorAll("th.sortable").forEach(x=>x.classList.remove("asc","desc"));h.classList.add(d);currentSort={key:k,dir:d};renderTable();});}
function compareSort(a,b,k,d){const m=d==="asc"?1:-1;if(k==="pos")return((a.__n.pos??1e9)-(b.__n.pos??1e9))*m;if(k==="team")return(a.display_name||"").localeCompare(b.display_name||"")*m;if(k==="start")return((a.starting_position??1e9)-(b.starting_position??1e9))*m;if(k==="interval")return((a.laps_complete??0)-(b.laps_complete??0))*-m;if(k==="best")return((a.__n.best??1e12)-(b.__n.best??1e12))*m;if(k==="laps")return((a.laps_complete??0)-(b.laps_complete??0))*-m;if(k==="inc")return((a.incidents??0)-(b.incidents??0))*m;return 0;}
function setupReset(){document.getElementById("resetBtn").onclick=()=>{selectedClass="all";document.getElementById("classFilter").value="all";currentSort={};document.querySelectorAll(".driver-row").forEach(r=>r.remove());renderTable();};}
loadResults();
</script>
</body>
</html>
